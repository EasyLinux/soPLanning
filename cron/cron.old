<?php
require_once('../database.inc');

/* 
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

function sRemoveAccents($str, $charset='utf-8')
{
    $str = htmlentities($str, ENT_NOQUOTES, $charset);
    
    $str = preg_replace('#&([A-za-z])(?:acute|cedil|caron|circ|grave|orn|ring|slash|th|tilde|uml);#', '\1', $str);
    $str = preg_replace('#&([A-za-z]{2})(?:lig);#', '\1', $str); // pour les ligatures e.g. '&oelig;'
    $str = preg_replace('#&[^;]+;#', '', $str); // supprime les autres caractères
    
    return $str;
}

// Lire les données de InfoCob
echo "Connexion en cours...   ";

$mysqli = new mysqli($cfgHostname, $cfgUsername, $cfgPassword, $cfgDatabase);

// check connection 
if (mysqli_connect_errno()) {
    printf("ERREUR Connection: %s\n", mysqli_connect_error());
    exit();
} 
echo "OK<br />";
// Chargement des données de config
$stmt = $mysqli->prepare("SELECT cle, valeur FROM planning_config;");
$stmt->bind_result($cle, $valeur);
$stmt->execute();
while( $stmt->fetch())
{
  define('CONFIG_' . $cle, $valeur);
}

/* NE PAS SUPPRIMER
//$sServer = "192.168.110.5";
//$sFdbFile = "D:/societe/infocob2000/Data/INFOCOB2000.GDB";
$sServer = "172.17.0.19";
$sFdbFile = "/var/lib/firebird/2.5/data/INFOCOB2000.GDB";
 */
$db_base = CONFIG_SYNCHRONIZE_SERVER . ":" . CONFIG_SYNCHRONIZE_FILE;
$db_user = CONFIG_SYNCHRONIZE_USER;
$db_pass = CONFIG_SYNCHRONIZE_PASS;

if ( $db=ibase_connect( $db_base,$db_user,$db_pass) )
{
    $Groups = explode(',',CONFIG_SYNCHRONIZE_GROUPS);
    $Or = '';
    $And = '';
    $Equipe = '(';
    
    foreach($Groups as $Group)
    {
      $Equipe .= "$Or i_familleinterlocuteur='$Group'";
      $Or = " OR";
    }
    $Equipe .= ')';
    
    if( $Equipe != "()")
      $And = "AND ";
    else
      $Equipe ="";
    
    $Sql = "SELECT i_code, i_nom, i_codecontact, i_prenom, i_inactif, i_email, i_familleinterlocuteur "
            . "FROM interlocuteurfiche "
            . "WHERE $Equipe $And"
            . "i_codecontact='492ATLC' "
            . "AND i_inactif='F';";

    $result = ibase_query( $Sql );

/*

    $Sql = "SELECT DISTINCT i_familleinterlocuteur,  "
            . "FROM interlocuteurfiche "
            . "WHERE i_codecontact='492ATLC' "
            . "AND i_inactif='F'";
    $result = ibase_query( $Sql );
    while( $aRow = ibase_fetch_assoc($result) )
    {
      if( !empty($aRow['I_FAMILLEINTERLOCUTEUR']))
      {
        echo iconv("ISO-8859-1","UTF-8",$aRow['I_FAMILLEINTERLOCUTEUR']) . "<br />";
      }
    }
    
    
    */
    
    /*
    
    $stmt = $mysqli->prepare("SELECT nom FROM planning_user_groupe WHERE nom=?");
    
    while( $aRow = ibase_fetch_assoc($result) )
    {
      if( !empty($aRow['I_FAMILLEINTERLOCUTEUR']))
      {
        $stmt->bind_param('s', $aRow['I_FAMILLEINTERLOCUTEUR']);
        $stmt->execute();
        if( ! $stmt->fetch() )
        {
          $stmt2 = $mysqli->prepare("INSERT INTO planning_user_groupe (nom) VALUES (?);");
          $stmt2->bind_param('s', $aRow['I_FAMILLEINTERLOCUTEUR']);
          $stmt2->execute();
        }
      }
    }

/*








//    $Sql = 'select rdb$relation_name from rdb$relations where rdb$view_blr is null '
//         . 'and (rdb$system_flag is null or rdb$system_flag = 0);';
//         
//    SELECT RDB$RELATION_NAME FROM RDB$RELATIONS WHERE RDB$VIEW_BLR IS NULL 
//           AND (RDB$SYSTEM_FLAG IS NULL OR RDB$SYSTEM_FLAG = 0);     
//         
//    $Sql = "SELECT f.RDB$RELATION_NAME AS Name, f.RDB$FIELD_NAME As FieldName " 
//         . "FROM RDB$RELATION_FIELDS f " 
//         . "JOIN RDB$RELATIONS r ON f.RDB$RELATION_NAME = r.RDB$RELATION_NAME "
//         . "AND r.RDB$VIEW_BLR IS NULL " 
//         . "AND (r.RDB$SYSTEM_FLAG IS NULL OR r.RDB$SYSTEM_FLAG = 0) " 
//         . "ORDER BY 1, f.RDB$FIELD_POSITION;";     
//         
//    $Sql = "SELECT ac_code, ac_typeaction, ac_date_prevu FROM actions WHERE ac_typeaction='71ATL';";
    $Be = "Bureau études";
    $Sql = "SELECT i_code, i_nom, i_codecontact, i_prenom, i_inactif, i_email, i_familleinterlocuteur "
            . "FROM interlocuteurfiche "
            . "WHERE (i_familleinterlocuteur='Technicien' "
            . "OR i_familleinterlocuteur='$Be') "
            . "AND i_codecontact='492ATLC' "
            . "AND i_inactif='F'";
            // . "WHERE i_codecontact='492ATLC';";
       //  
//    $Sql = "SELECT af_code, af_datedebut, af_datefin, af_nom, af_type, af_typeaffaire FROM affaire WHERE af_datedebut LIKE '2017%';";
    //$Sql = "SHOW TABLES;";

    //echo ibase_db_info ( $db , $db_base , 0 );

    echo $Sql . "<br />";
    echo "Requesting ...  <br />&nbsp;&nbsp;&nbsp;". iconv("ISO-8859-1","UTF-8",$Sql);
    $result = ibase_query( $Sql );
    echo "<br />...OK ".ibase_errcode(). " - ".ibase_errmsg() . "<br /><br />";

    while( $aRow = ibase_fetch_assoc($result) )
      {
      $mSql = "INSERT INTO tmpUser SET user_id='" . $aRow['I_CODE'] . "', "
            . "nom='". iconv("ISO-8859-1","UTF-8",$aRow['I_NOM'])."', prenom='". 
              iconv("ISO-8859-1","UTF-8",$aRow['I_PRENOM'])."',"
            . "login='".sRemoveAccents(strtolower(iconv("ISO-8859-1","UTF-8",
                    substr($aRow['I_PRENOM'],1,1).$aRow['I_NOM'])))."'";
      //print_r($aRow);
      /*
      foreach($aRow as $Val)
      {
        echo iconv("ISO-8859-1","UTF-8",  $Val).", ";
      } /
      echo "<br />".$mSql ."<br/>";
      }
    //echo "ERREUR: (" . ibase_errcode() . ") " . ibase_errmsg() . "<br/>";
    //echo "OK ". ibase_errcode(). " - ".ibase_errmsg(). " <br />";
    print_r($aRow);
            // . "WHERE i_codecontact='492ATLC';";
       //  
//    $Sql = "SELECT af_code, af_datedebut, af_datefin, af_nom, af_type, af_typeaffaire FROM affaire WHERE af_datedebut LIKE '2017%';";
    //$Sql = "SHOW TABLES;";

    //echo ibase_db_info ( $db , $db_base , 0 );
*/
}
else
{
    echo "ERREUR: (". ibase_errcode().") ".ibase_errmsg();
}

//     ibase_commit();     // note parenthesis but no parameters.

//     ibase_close;        // note total lack of parenthesis and parameters !



